<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavandowski - Sistema Integrado</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;700&family=Inter:wght@300;400;600;800&display=swap');
        
        :root {
            --bg-color: #0a0e17;
            --card-bg: #141b2d;
            --neon-blue: #00f0ff;
            --neon-purple: #7b2ff7;
            --dark-blue: #070b19;
            --text-color: #e0e7ff;
            --accent-color: #00ccff;
            --grid-line: rgba(25, 118, 210, 0.12);
            --glow-intensity: 8px;
            --danger-color: #ff3a5e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(17, 123, 215, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(123, 47, 247, 0.08) 0%, transparent 25%),
                linear-gradient(var(--bg-color), var(--bg-color)),
                repeating-linear-gradient(transparent, transparent 50px, var(--grid-line) 50px, var(--grid-line) 51px),
                repeating-linear-gradient(90deg, transparent, transparent 50px, var(--grid-line) 50px, var(--grid-line) 51px);
        }
        
        header {
            padding: 1.5rem 0 0;
            text-align: center;
            position: relative;
            margin-bottom: 1rem;
        }
        
        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.03em;
            text-align: center;
            position: relative;
        }
        
        h1::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: blur(var(--glow-intensity));
            opacity: 0.5;
            z-index: -1;
        }
        
        .subtitle {
            font-family: 'Roboto Mono', monospace;
            text-transform: uppercase;
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.3em;
            color: rgba(224, 231, 255, 0.7);
            margin: 0.5rem 0 0.5rem;
            padding-top: 0.5rem;
        }
        
        .container {
            width: 98%;
            max-width: 1800px;
            margin: 0 auto 1.5rem;
            padding: 1.5rem;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 204, 255, 0.1);
            overflow: auto;
            position: relative;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 180px);
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                rgba(0, 204, 255, 0), 
                rgba(0, 204, 255, 0.5), 
                rgba(123, 47, 247, 0.5), 
                rgba(0, 204, 255, 0));
        }
        
        .mermaid {
            font-size: 16px;
            font-family: 'Roboto Mono', monospace;
            width: 100%;
            height: 100%;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .controls button {
            background: rgba(0, 204, 255, 0.1);
            color: var(--accent-color);
            border: 1px solid rgba(0, 204, 255, 0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 6px;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .controls button:hover {
            background: rgba(0, 204, 255, 0.2);
            border-color: var(--accent-color);
        }
        
        .controls button.danger {
            background: rgba(255, 58, 94, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(255, 58, 94, 0.3);
        }
        
        .controls button.danger:hover {
            background: rgba(255, 58, 94, 0.2);
            border-color: var(--danger-color);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }
            .container {
                padding: 1rem;
            }
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 2rem;
            border: 1px solid rgba(0, 204, 255, 0.2);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--accent-color);
        }
        
        .modal h2 {
            color: var(--danger-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .modal p {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }
        
        .modal-buttons button {
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            font-family: 'Roboto Mono', monospace;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-buttons .cancel {
            background: transparent;
            color: var(--text-color);
            border: 1px solid rgba(224, 231, 255, 0.3);
        }
        
        .modal-buttons .confirm {
            background: var(--danger-color);
            color: white;
            border: none;
        }
        
        .modal-buttons .cancel:hover {
            background: rgba(224, 231, 255, 0.1);
        }
        
        .modal-buttons .confirm:hover {
            background: #ff1a43;
        }
    </style>
</head>
<body>
    <header>
        <h1>LAVANDOWSKI <i class="fas fa-microchip"></i> <i class="fas fa-brain"></i></h1>
        <div class="subtitle">Sistema Integrado de Dados e IA</div>
    </header>
    
    <div class="container">
        <div class="mermaid">
            flowchart TB
              %% Estilo e cores - Tech AI Theme
              classDef source fill:#151e33,stroke:#1e88e5,stroke-width:2px,color:#e0e7ff
              classDef filter fill:#0c2135,stroke:#00b8d4,stroke-width:2px,color:#e0e7ff
              classDef enrichment fill:#131129,stroke:#6200ea,stroke-width:2px,color:#e0e7ff
              classDef process fill:#10243e,stroke:#0288d1,stroke-width:2px,color:#e0e7ff
              classDef analysis fill:#271216,stroke:#ff1744,stroke-width:2px,color:#e0e7ff
              classDef pipeline fill:#071b12,stroke:#00c853,stroke-width:2px,color:#e0e7ff
              classDef risk fill:#1e1a10,stroke:#ffc400,stroke-width:2px,color:#e0e7ff
              classDef details fill:#22190e,stroke:#ff9100,stroke-width:2px,color:#e0e7ff
              classDef regulatory fill:#251425,stroke:#e040fb,stroke-width:2px,color:#e0e7ff
              classDef action fill:#2d1210,stroke:#ff3d00,stroke-width:2px,color:#e0e7ff
              classDef identity fill:#151e33,stroke:#1e88e5,stroke-width:2px,color:#e0e7ff
              classDef criteria fill:#1e1a10,stroke:#ffc400,stroke-width:2px,color:#e0e7ff
              classDef decision fill:#071b12,stroke:#00c853,stroke-width:2px,color:#e0e7ff
              classDef enforcement fill:#2d1210,stroke:#ff3d00,stroke-width:2px,color:#e0e7ff
              
              %% PARTE 1 - ENTRADA DE DADOS
              EntradaDados["üíæ FONTES DE DADOS"]
              
              %% ALERTAS TRADICIONAIS
              AlertasTrad["üìä ALERTAS TRADICIONAIS<br>(maindb.offense_analyses)"]
              AlertasTradList["- CH Alert (analista_id: 8423054)<br>- Pep_Pix Alert (analista_id: 8832903)<br>- GAFI Alert (analista_id: 15858378)<br>- Merchant_Pix Alert (analista_id: 16368511)<br>- International_Cards_Alert (analista_id: 18758930)<br>- Bank_Slips_Alert (analista_id: 19897830)<br>- Goverment_Corporate_Cards_Alert (analista_id: 20583019)<br>- Betting_Houses_Alert (analista_id: 20698248)<br>- GAFI Alert [US] (analista_id: 25071066)<br>+ 10 outros tipos de alertas"]
              
              AlertasCH["CH ALERT"]
              AlertasCHDet["- Transa√ß√µes de cash in/out em montantes suspeitos<br>- Padr√µes estruturados de dep√≥sitos<br>- Saques em caixas eletr√¥nicos<br>- Dep√≥sitos presenciais<br>- Opera√ß√µes de c√¢mbio"]
              
              AlertasPIX["PEP_PIX & MERCHANT_PIX ALERTS"]
              AlertasPIXDet["- Pep_Pix: Opera√ß√µes PIX envolvendo PEPs<br>- Merchant_Pix: Padr√µes at√≠picos em PIX de comerciantes<br>- Transa√ß√µes PIX fora do padr√£o<br>- Concentra√ß√£o de transfer√™ncias<br>- Fragmenta√ß√£o de valores"]
              
              AlertasInternacionais["GAFI & INTERNATIONAL ALERTS"]
              AlertasInternacionaisDet["- GAFI Alert: Transa√ß√µes com pa√≠ses na lista GAFI/FATF<br>- GAFI Alert [US]: Variante para opera√ß√µes com EUA<br>- International_Cards_Alert: Uso de cart√µes em transa√ß√µes internacionais<br>- Opera√ß√µes com jurisdi√ß√µes de alto risco"]
              
              AlertasOutros["OUTROS ALERTAS"]
              AlertasOutrosDet["- Bank_Slips_Alert: Emiss√£o/pagamento de boletos suspeitos<br>- Goverment_Corporate_Cards_Alert: Uso at√≠pico de cart√µes gov/corp<br>- Betting_Houses_Alert: Transa√ß√µes com casas de apostas<br>+ 10 outros tipos de alertas espec√≠ficos"]
              
              %% ALERTAS DE IA
              AlertasIA["ü§ñ ALERTAS DE IA<br>(ai-services-sae.aml_model.predictions)"]
              AlertasIAList["- user_id: ID do usu√°rio<br>- timestamp: Data/hora da predi√ß√£o<br>- score: Score num√©rico de risco<br>- features: Features utilizadas para detec√ß√£o<br>- label: 1 (positivo/suspeito)"]
              
              %% FILTRAGEM
              FiltragemExclusoes["üîç FILTRAGEM E EXCLUS√ïES"]
              ExclusoesAuto["EXCLUS√ïES AUTOM√ÅTICAS (fetch_data.py)"]
              ExclusoesAutoDet["- Usu√°rios analisados nos √∫ltimos 15 dias<br>- Casos com offense_id = 'money_laundering'<br>- Combina√ß√µes espec√≠ficas de conclusion/priority<br>- automatic_pipeline = true"]
              
              %% ENRIQUECIMENTO
              EnriquecimentoDados["üîÑ ENRIQUECIMENTO DE DADOS"]
              
              %% PERFIL MERCHANT
              PerfilMerchant["PERFIL MERCHANT<br>(merchant_report em functions.py)"]
              
              MerchantInfo["MERCHANT_INFO"]
              MerchantInfoDet["Informa√ß√µes demogr√°ficas e cadastrais do comerciante:<br>- Dados de registro<br>- Setor de atua√ß√£o<br>- Perfil declarado<br>- Hist√≥rico como cliente"]
              
              IssuingConcentration["ISSUING_CONCENTRATION"]
              IssuingConcentrationDet["An√°lise de concentra√ß√£o por emissores:<br>- Concentra√ß√£o por bandeira<br>- Concentra√ß√£o por bancos emissores<br>- Padr√µes temporais de transa√ß√µes por emissor"]
              
              TransactionConcentration["TRANSACTION_CONCENTRATION"]
              TransactionConcentrationDet["Concentra√ß√£o por tipos de transa√ß√µes:<br>- Valor m√©dio por transa√ß√£o<br>- Padr√µes de valores<br>- Distribui√ß√£o por tipo de transa√ß√£o<br>- Recorr√™ncia e padr√µes temporais"]
              
              PIXConcentration["PIX_CONCENTRATION"]
              PIXConcentrationDet["An√°lise espec√≠fica de opera√ß√µes PIX:<br>- Volume e frequ√™ncia PIX<br>- Padr√µes temporais PIX<br>- Concentra√ß√£o por destinat√°rios PIX<br>- Rela√ß√£o com outras transa√ß√µes"]
              
              %% An√°lise de Hor√°rios At√≠picos
              HorariosAtipicos["AN√ÅLISE DE HOR√ÅRIOS AT√çPICOS<br>(merchant_report em functions.py)"]
              HorariosAtipicosDetail["- Cash In PIX em hor√°rios at√≠picos: total_cash_in_pix_atypical_hours<br>- Cash Out PIX em hor√°rios at√≠picos: total_cash_out_pix_atypical_hours<br>- Percentual de opera√ß√µes noturnas<br>- Identifica√ß√£o de padr√µes temporais suspeitos"]
              
              %% Verifica√ß√£o de BINs Governamentais
              BINsGovernamentais["PROCESSAMENTO DE BINS GOVERNAMENTAIS<br>(Goverment_Corporate_Cards_Alert)"]
              BINsGovernamentaisDetail["- Verifica√ß√£o de BINs espec√≠ficos: 409869, 467481, 498409<br>- Identifica√ß√£o de cart√µes corporativos governamentais<br>- C√°lculo de percentual sobre TPV total<br>- Detec√ß√£o de anomalias em padr√µes de uso"]
              
              Devices["DEVICES"]
              DevicesDet["An√°lise de dispositivos utilizados:<br>- IPs e geolocaliza√ß√£o<br>- Dispositivos registrados<br>- Padr√µes de acesso<br>- Anomalias de localiza√ß√£o"]
              
              Contacts["CONTACTS"]
              ContactsDet["An√°lise de contrapartes:<br>- Contrapartes frequentes<br>- Volume por contraparte<br>- Perfil das contrapartes<br>- Padr√µes de intera√ß√£o"]
              
              Products["PRODUCTS"]
              ProductsDet["Produtos financeiros utilizados:<br>- Tipos de produtos<br>- Frequ√™ncia de uso<br>- Padr√µes de utiliza√ß√£o"]
              
              OffenseHistory["OFFENSE_HISTORY"]
              OffenseHistoryDet["Hist√≥rico de ofensas anteriores:<br>- Alertas pr√©vios<br>- Resolu√ß√µes anteriores<br>- Padr√µes recorrentes<br>- Resultados de investiga√ß√µes passadas"]
              
              %% PERFIL INDIVIDUAL
              PerfilIndividual["PERFIL INDIVIDUAL<br>(individual_report em functions.py)"]
              
              UserInfo["USER_INFO"]
              UserInfoDet["Dados cadastrais e informa√ß√µes b√°sicas:<br>- Dados pessoais<br>- Hist√≥rico como cliente<br>- Status da conta<br>- Perfil declarado"]
              
              %% Verifica√ß√£o de Estrangeiros
              VerificacaoEstrangeiros["VERIFICA√á√ÉO DE ESTRANGEIROS<br>(ch_alert [BR])"]
              VerificacaoEstrangeirosDetail["- An√°lise de nomes que n√£o soam brasileiros<br>- Verifica√ß√£o de CPFs com data de cria√ß√£o recente<br>- Correla√ß√£o com padr√µes transacionais internacionais<br>- Identifica√ß√£o de poss√≠veis laranjas ou terceiros"]
              
              FinancialProfile["FINANCIAL_PROFILE"]
              FinancialProfileDet["Perfil financeiro do usu√°rio:<br>- Movimenta√ß√£o m√©dia<br>- Fontes de recursos<br>- Destino dos recursos<br>- Compatibilidade com perfil declarado"]
              
              TransactionHistory["TRANSACTION_HISTORY"]
              TransactionHistoryDet["Hist√≥rico detalhado de transa√ß√µes:<br>- Padr√µes temporais<br>- Tipos de opera√ß√µes<br>- Valores e frequ√™ncias<br>- Contrapartes recorrentes"]
              
              SuspiciousPatterns["SUSPICIOUS_PATTERNS"]
              SuspiciousPatternsDet["Padr√µes espec√≠ficos de suspeita:<br>- Fragmenta√ß√£o de valores<br>- Opera√ß√µes estruturadas<br>- Triangula√ß√µes<br>- Transa√ß√µes at√≠picas ao perfil"]
              
              %% DADOS COMPLEMENTARES
              DadosComplementares["DADOS COMPLEMENTARES"]
              
              DadosPEP["DADOS PEP<br>(fetch_pep_data em functions.py)"]
              DadosPEPDet["- Status PEP (Pessoa Exposta Politicamente)<br>- Cargo p√∫blico<br>- √ìrg√£o/entidade<br>- Data de in√≠cio e fim da exposi√ß√£o"]
              
              DadosJudiciais["DADOS JUDICIAIS<br>(fetch_lawsuit_data em functions.py)"]
              DadosJudiciaisDet["- Processos judiciais ativos<br>- Natureza dos processos<br>- Status atual<br>- Valores envolvidos"]
              
              DadosApostas["DADOS DE CASAS DE APOSTAS<br>(fetch_betting_houses em functions.py)"]
              DadosApostasDet["- Transa√ß√µes com casas de apostas<br>- Frequ√™ncia e valores<br>- Padr√µes de apostas"]
              
              SancoesHistorico["HIST√ìRICO DE SAN√á√ïES<br>(fetch_sanctions_history em functions.py)"]
              SancoesHistoricoDet["- San√ß√µes anteriores aplicadas<br>- Entidades aplicadoras<br>- Per√≠odo e dura√ß√£o<br>- Motivos das san√ß√µes"]
              
              TransacoesNegadas["TRANSA√á√ïES NEGADAS<br>(fetch_denied_transactions em functions.py)"]
              TransacoesNegadasDet["- Opera√ß√µes recusadas pelo sistema<br>- Motivos de recusa<br>- Padr√µes de tentativas<br>- Perfil das transa√ß√µes negadas"]
              
              TransacoesPrisao["TRANSA√á√ïES EM PRES√çDIOS<br>(fetch_prison_transactions em functions.py)"]
              TransacoesPrisaoDet["- Opera√ß√µes realizadas de √°reas prisionais<br>- Frequ√™ncia e valores<br>- Destinat√°rios das opera√ß√µes<br>- Padr√µes temporais"]
              
              RelacionamentosEmpresariais["RELACIONAMENTOS EMPRESARIAIS<br>(fetch_business_data em functions.py)"]
              RelacionamentosEmpresariaisDet["- V√≠nculos empresariais do cliente<br>- Participa√ß√£o societ√°ria<br>- Cargos e fun√ß√µes<br>- Hist√≥rico das empresas relacionadas"]
              
              %% CONEX√ïES INICIAIS
              EntradaDados --- AlertasTrad & AlertasIA
              
              AlertasTrad --> AlertasTradList
              AlertasTradList --> AlertasCH & AlertasPIX & AlertasInternacionais & AlertasOutros
              AlertasCH --> AlertasCHDet
              AlertasPIX --> AlertasPIXDet
              AlertasInternacionais --> AlertasInternacionaisDet
              AlertasOutros --> AlertasOutrosDet
              
              AlertasIA --> AlertasIAList
              
              AlertasCHDet & AlertasPIXDet & AlertasInternacionaisDet & AlertasOutrosDet & AlertasIAList --> FiltragemExclusoes
              
              FiltragemExclusoes --> ExclusoesAuto
              ExclusoesAuto --> ExclusoesAutoDet
              
              %% CONEX√ïES ENRIQUECIMENTO
              ExclusoesAutoDet --> EnriquecimentoDados
              
              EnriquecimentoDados --> PerfilMerchant & PerfilIndividual & DadosComplementares
              
              PerfilMerchant --> MerchantInfo & IssuingConcentration & TransactionConcentration & PIXConcentration & HorariosAtipicos & BINsGovernamentais & Devices & Contacts & Products & OffenseHistory
              MerchantInfo --> MerchantInfoDet
              IssuingConcentration --> IssuingConcentrationDet
              TransactionConcentration --> TransactionConcentrationDet
              PIXConcentration --> PIXConcentrationDet
              HorariosAtipicos --> HorariosAtipicosDetail
              BINsGovernamentais --> BINsGovernamentaisDetail
              Devices --> DevicesDet
              Contacts --> ContactsDet
              Products --> ProductsDet
              OffenseHistory --> OffenseHistoryDet
              
              PerfilIndividual --> UserInfo & FinancialProfile & TransactionHistory & SuspiciousPatterns
              UserInfo --> UserInfoDet
              UserInfoDet --> VerificacaoEstrangeiros
              VerificacaoEstrangeiros --> VerificacaoEstrangeirosDetail
              FinancialProfile --> FinancialProfileDet
              TransactionHistory --> TransactionHistoryDet
              SuspiciousPatterns --> SuspiciousPatternsDet
              
              DadosComplementares --> DadosPEP & DadosJudiciais & DadosApostas & SancoesHistorico & TransacoesNegadas & TransacoesPrisao & RelacionamentosEmpresariais
              DadosPEP --> DadosPEPDet
              DadosJudiciais --> DadosJudiciaisDet
              DadosApostas --> DadosApostasDet
              SancoesHistorico --> SancoesHistoricoDet
              TransacoesNegadas --> TransacoesNegadasDet
              TransacoesPrisao --> TransacoesPrisaoDet
              RelacionamentosEmpresariais --> RelacionamentosEmpresariaisDet
              
              %% PROCESSAMENTO
              ProcessamentoDados["‚öôÔ∏è PROCESSAMENTO DE DADOS"]
              
              FormatacaoDados["FORMATA√á√ÉO DOS DADOS<br>(functions.py)"]
              FormatacaoDadosDet["- Convers√£o de tipos de dados<br>- Formata√ß√£o de datas (format_date_portuguese)<br>- Convers√£o de valores decimais (convert_decimals)<br>- Estrutura√ß√£o hier√°rquica de informa√ß√µes"]
              
              GeracaoPrompt["GERA√á√ÉO DE PROMPT ESTRUTURADO<br>(gpt_utils.py)"]
              GeracaoPromptDet["- Formata√ß√£o dos dados para an√°lise<br>- Estrutura√ß√£o segundo contexto regulat√≥rio<br>- Inclus√£o de informa√ß√µes hist√≥ricas relevantes"]
              
              %% Tratamento Espec√≠fico por Tipo de Alerta
              TratamentoEspecificoAlerta["TRATAMENTO PERSONALIZADO POR ALERTA<br>(generate_prompt em functions.py)"]
              TratamentoEspecificoAlertaDetail["- Instru√ß√µes espec√≠ficas para bank_slips_alert<br>- Instru√ß√µes espec√≠ficas para international_cards_alert<br>- Instru√ß√µes espec√≠ficas para betting_houses_alert<br>- Instru√ß√µes espec√≠ficas para gafi_alert<br>- Instru√ß√µes espec√≠ficas para ch_alert [BR]<br>- Instru√ß√µes espec√≠ficas para pix_merchant_alert"]
              
              %% SISTEMA PROMPT
              SystemPrompt["üß† SYSTEM PROMPT<br>gpt_utils.py"]
              
              %% IDENTIDADE E FUN√á√ÉO
              AnalystIdentity["üë§ IDENTIDADE E FUN√á√ÉO"]
              AnalystIdentityDetails["- Analista s√™nior certificado pela ACAMS<br>- Especialista em Preven√ß√£o √† Lavagem de Dinheiro<br>- Fun√ß√£o: Analisar anomalias e ind√≠cios de lavagem<br>- Respons√°vel por tomar decis√µes sobre casos"]
              
              %% PAR√ÇMETROS DE AN√ÅLISE  
              AnalysisParams["üîç PAR√ÇMETROS DE AN√ÅLISE"]
              AnalysisParamsDetails["- An√°lise de Cash In e Cash Out<br>- Verifica√ß√£o de repeti√ß√µes em titulares de cart√£o<br>- An√°lise de transa√ß√µes via PIX<br>- Verifica√ß√£o de TPV e concentra√ß√£o com portadores<br>- Identifica√ß√£o de opera√ß√µes via issuing<br>- An√°lise de relacionamentos empresariais"]
              
              %% INSTRU√á√ïES DE PROCESSAMENTO
              DataProcessing["üìä INSTRU√á√ïES DE PROCESSAMENTO"]
              DataProcessingDetails["- Evitar encaminhamento por suspeitas leves<br>- Analisar contexto geral de cada caso<br>- Tratar PIX Cash Out de forma diferente de saques<br>- Fornecer justificativas detalhadas<br>- Identificar conex√µes entre partes<br>- Considerar frequ√™ncia e valores das transa√ß√µes"]
              
              %% CRIT√âRIOS OBRIGAT√ìRIOS
              MandatoryAnalysisCriteria["üìã CRIT√âRIOS OBRIGAT√ìRIOS DE AN√ÅLISE"]
              MandatoryAnalysisCriteriaDetails["Para TODOS os alertas devem ser inclu√≠das:<br>- Perfil do Cliente<br>- Movimenta√ß√µes Financeiras<br>- Hist√≥rico de Offenses<br>- Relacionamentos Econ√¥micos<br>- Padr√µes e Comportamentos<br>- Processos judiciais em andamento/conclu√≠dos"]
              
              %% CLASSIFICA√á√ÉO DE RISCO
              RiskClassification["‚ö†Ô∏è CLASSIFICA√á√ÉO DE RISCO"]
              RiskClassificationDetails["Escala de 1 a 10 onde:<br>- 1 a 5: Baixo risco (normaliza√ß√£o do caso)<br>- 6: M√©dio risco (normaliza√ß√£o com monitoramento)<br>- 7 a 8: M√©dio-Alto risco (valida√ß√£o adicional - BV)<br>- 9: Alto risco (valida√ß√£o adicional urgente - BV)<br>- 10: Risco extremo (descredenciamento e COAF)"]
              
              %% FRAMEWORK REGULAT√ìRIO
              RegulatoryFramework["üìú FRAMEWORK REGULAT√ìRIO"]
              RegulatoryFrameworkDetails["- Fundamenta√ß√£o em al√≠neas da Carta Circular 4001<br>- Aplica√ß√£o criteriosa e conservadora<br>- Cita√ß√£o apenas com evid√™ncias concretas<br>- Evitar associa√ß√µes for√ßadas<br>- Explica√ß√£o precisa de cada al√≠nea aplicada"]
              
              %% CONEX√ïES PROCESSAMENTO
              MerchantInfoDet & IssuingConcentrationDet & TransactionConcentrationDet & PIXConcentrationDet & DevicesDet & ContactsDet & ProductsDet & OffenseHistoryDet & UserInfoDet & FinancialProfileDet & TransactionHistoryDet & SuspiciousPatternsDet & DadosPEPDet & DadosJudiciaisDet & DadosApostasDet & SancoesHistoricoDet & TransacoesNegadasDet & TransacoesPrisaoDet & RelacionamentosEmpresariaisDet --> ProcessamentoDados
              
              ProcessamentoDados --> FormatacaoDados & GeracaoPrompt
              FormatacaoDados --> FormatacaoDadosDet
              GeracaoPrompt --> GeracaoPromptDet
              
              GeracaoPromptDet --> TratamentoEspecificoAlerta --> TratamentoEspecificoAlertaDetail
              
              GeracaoPromptDet --> SystemPrompt
              
              SystemPrompt --> AnalystIdentity & AnalysisParams & DataProcessing & MandatoryAnalysisCriteria & RiskClassification & RegulatoryFramework
              
              AnalystIdentity --> AnalystIdentityDetails
              AnalysisParams --> AnalysisParamsDetails
              DataProcessing --> DataProcessingDetails
              MandatoryAnalysisCriteria --> MandatoryAnalysisCriteriaDetails
              RiskClassification --> RiskClassificationDetails
              RegulatoryFramework --> RegulatoryFrameworkDetails
              
              %% PIPELINE DE IA
              PipelineIA["üß† PIPELINE DE IA"]
              
              AnalisePrincipal["1. AN√ÅLISE PRINCIPAL COM GPT-4o<br>(gpt_utils.py)"]
              AnalisePrincipalDet["FUNCTION: get_chatgpt_response()<br>PARAMETERS:<br>- model: gpt-4o-2024-11-20<br>- temperature: 0.0<br>- messages:<br>* system: SYSTEM_PROMPT<br>* user: dados estruturados do caso<br><br>AN√ÅLISE PRODUZIDA:<br>- Perfil do Cliente<br>- Movimenta√ß√µes Financeiras<br>- Hist√≥rico de Offenses<br>- Relacionamentos Econ√¥micos<br>- Padr√µes e Comportamentos<br>- Processos judiciais<br>- Poss√≠vel pontua√ß√£o de risco (1-10)"]
              
              %% Fallback para Contextos Longos
              FallbackContextosLongos["FALLBACK PARA CONTEXTOS LONGOS<br>(get_chatgpt_response em gpt_utils.py)"]
              FallbackContextosLongosDetail["- Detec√ß√£o de erro 'context_length_exceeded'<br>- Redirecionamento para an√°lise humana<br>- Mensagem espec√≠fica: 'N√£o consigo tankar este caso'<br>- Tratamento de casos complexos"]
              
              PipelineIA --> AnalisePrincipal
              AnalisePrincipal --> AnalisePrincipalDet
              AnalisePrincipalDet --> FallbackContextosLongos
              FallbackContextosLongos --> FallbackContextosLongosDetail
              FallbackContextosLongosDetail --> VerificacaoScore
              
              VerificacaoScore["2. VERIFICA√á√ÉO DE SCORE<br>(gpt_utils.py)"]
              VerificacaoScoreDet["FUNCTION: get_analysis_and_decision()<br>- Verifica se 'Risco de Lavagem de Dinheiro:' est√° presente<br>- Se n√£o estiver:<br>* Cria score_prompt solicitando classifica√ß√£o<br>* Envia para o3-mini-2025-01-31<br>* Adiciona score √† an√°lise original"]
              
              DecisaoFinal["3. DECIS√ÉO FINAL COM O3-mini<br>(gpt_utils.py)"]
              DecisaoFinalDet["FUNCTION: get_analysis_and_decision()<br>PARAMETERS:<br>- model: o3-mini-2025-01-31<br>- reasoning_effort: high<br>- messages:<br>* system: SYSTEM_PROMPT<br>* user: decision_prompt com an√°lise completa do GPT-4o<br><br>RESULTADO:<br>- Decis√£o final em exatamente duas linhas<br>- Inclus√£o do score de risco<br>- Men√ß√£o √†s principais al√≠neas da Carta Circular 4001<br>- Solicita√ß√£o de documentos quando necess√°rio"]
              
              ComposicaoResultado["4. COMPOSI√á√ÉO DO RESULTADO<br>(gpt_utils.py)"]
              ComposicaoResultadoDet["- Jun√ß√£o da an√°lise detalhada do GPT-4o<br>- Inclus√£o do score (original ou gerado pelo o3-mini)<br>- Adi√ß√£o da decis√£o concisa do o3-mini<br>- Resultado completo em formato de texto"]
              
              %% Integra√ß√£o com API de Risk
              IntegracaoAPIRisk["INTEGRA√á√ÉO COM API DE RISK<br>(send_payload em app.py)"]
              IntegracaoAPIRiskDetail["- Envio via API REST para infinitepay-risk-api<br>- Endpoint: /monitoring/offense_analysis<br>- Autentica√ß√£o via key_master<br>- Payload estruturado com an√°lise e resultados"]
              
              %% RESULTADOS
              ResultadosAnalise["üìä RESULTADOS DA AN√ÅLISE"]
              
              %% Tracking de Usu√°rios Sinalizados
              TrackingUsuarios["TRACKING DE USU√ÅRIOS SINALIZADOS<br>(run_bot em app.py)"]
              TrackingUsuariosDetail["- Monitoramento de status de an√°lise<br>- Rastreamento de usu√°rios em processo<br>- Registro de timestamp de an√°lise: datetime.now()<br>- Medi√ß√£o de efici√™ncia do processo<br>- Progress bar de an√°lise"]
              
              ClassificacaoRisco["CLASSIFICA√á√ÉO DE RISCO"]
              ClassificacaoRiscoDet["- Score 1-4: Baixo risco (normaliza√ß√£o do caso)<br>- Score 5-6: M√©dio risco (normaliza√ß√£o com monitoramento)<br>- Score 7-9: Alto risco (valida√ß√£o adicional - BV)<br>- Score 10: Risco extremo (descredenciamento e COAF)"]
              
              DecisaoAcionavel["DECIS√ÉO ACION√ÅVEL"]
              DecisaoAcionavelDet["- Normaliza√ß√£o do caso<br>OU<br>- Solicita√ß√£o de Business Validation (BV)<br>* Comprovantes de endere√ßo<br>* Comprovantes de renda<br>* Documenta√ß√£o adicional<br>OU<br>- Descredenciamento<br>* Bloqueio imediato do cliente<br>* Fechamento da conta<br>* Reporte autom√°tico ao COAF"]
              
              FundamentacaoRegulatoria["FUNDAMENTA√á√ÉO REGULAT√ìRIA"]
              FundamentacaoRegulatoriaDet["- Al√≠neas espec√≠ficas da Carta Circular 4001<br>- Justificativa para cada al√≠nea identificada<br>- Correla√ß√£o entre dados observados e suspeitas"]
              
              %% A√á√ïES REGULAT√ìRIAS ESPECIAIS
              AcoesRegulatorias["‚ö†Ô∏è A√á√ïES REGULAT√ìRIAS ESPECIAIS"]
              
              ReporteCOAF["REPORTE AO COAF"]
              ReporteCOAFDet["- Comunica√ß√£o de Opera√ß√£o Suspeita (COS)<br>- Inclus√£o de toda documenta√ß√£o<br>- Indica√ß√£o das al√≠neas da CC 4001<br>- Prazo de 24h para opera√ß√µes urgentes"]
              
              Descredenciamento["DESCREDENCIAMENTO"]
              DescredenciamentoDet["- Bloqueio preventivo da conta<br>- Notifica√ß√£o ao cliente<br>- Encerramento da rela√ß√£o comercial<br>- Monitoramento adicional de contas relacionadas"]
              
              MonitoramentoEspecial["MONITORAMENTO ESPECIAL"]
              MonitoramentoEspecialDet["- Inclus√£o em lista de monitoramento<br>- Verifica√ß√£o peri√≥dica de transa√ß√µes<br>- Valida√ß√µes adicionais para opera√ß√µes sens√≠veis<br>- Revis√£o a cada 90 dias"]
              
              %% CONEX√ïES PIPELINE E RESULTADOS
              RegulatoryFrameworkDetails & AnalystIdentityDetails & AnalysisParamsDetails & DataProcessingDetails & MandatoryAnalysisCriteriaDetails & RiskClassificationDetails --> PipelineIA
              
              VerificacaoScore --> VerificacaoScoreDet
              VerificacaoScoreDet --> DecisaoFinal --> DecisaoFinalDet
              DecisaoFinalDet --> ComposicaoResultado --> ComposicaoResultadoDet
              
              ComposicaoResultadoDet --> IntegracaoAPIRisk --> IntegracaoAPIRiskDetail
              
              ComposicaoResultadoDet --> ResultadosAnalise
              
              ResultadosAnalise --> ClassificacaoRisco & DecisaoAcionavel & FundamentacaoRegulatoria & TrackingUsuarios
              TrackingUsuarios --> TrackingUsuariosDetail
              TrackingUsuariosDetail --> TratamentoEspecificoAlerta
              
              ClassificacaoRisco --> ClassificacaoRiscoDet
              DecisaoAcionavel --> DecisaoAcionavelDet
              FundamentacaoRegulatoria --> FundamentacaoRegulatoriaDet
              
              ClassificacaoRiscoDet & DecisaoAcionavelDet --> AcoesRegulatorias
              AcoesRegulatorias --> ReporteCOAF & Descredenciamento & MonitoramentoEspecial
              ReporteCOAF --> ReporteCOAFDet
              Descredenciamento --> DescredenciamentoDet
              MonitoramentoEspecial --> MonitoramentoEspecialDet
              
              %% Aplica√ß√£o de estilos adicionais
              class PipelineIA,AnalisePrincipal,AnalisePrincipalDet,VerificacaoScore,VerificacaoScoreDet,DecisaoFinal,DecisaoFinalDet,ComposicaoResultado,ComposicaoResultadoDet analysis
              
              class ResultadosAnalise,ClassificacaoRisco,ClassificacaoRiscoDet,DecisaoAcionavel,DecisaoAcionavelDet,FundamentacaoRegulatoria,FundamentacaoRegulatoriaDet pipeline
              
              class AcoesRegulatorias,ReporteCOAF,ReporteCOAFDet,Descredenciamento,DescredenciamentoDet,MonitoramentoEspecial,MonitoramentoEspecialDet action
              
              class TratamentoEspecificoAlerta,TratamentoEspecificoAlertaDetail process
              class IntegracaoAPIRisk,IntegracaoAPIRiskDetail process
              
              %% Aplica√ß√£o de estilos
              class EnriquecimentoDados,PerfilMerchant,MerchantInfo,MerchantInfoDet,IssuingConcentration,IssuingConcentrationDet,TransactionConcentration,TransactionConcentrationDet,PIXConcentration,PIXConcentrationDet,Devices,DevicesDet,Contacts,ContactsDet,Products,ProductsDet,OffenseHistory,OffenseHistoryDet,PerfilIndividual,UserInfo,UserInfoDet,FinancialProfile,FinancialProfileDet,TransactionHistory,TransactionHistoryDet,SuspiciousPatterns,SuspiciousPatternsDet,DadosComplementares,DadosPEP,DadosPEPDet,DadosJudiciais,DadosJudiciaisDet,DadosApostas,DadosApostasDet,SancoesHistorico,SancoesHistoricoDet,TransacoesNegadas,TransacoesNegadasDet,TransacoesPrisao,TransacoesPrisaoDet,RelacionamentosEmpresariais,RelacionamentosEmpresariaisDet,HorariosAtipicos,HorariosAtipicosDetail,BINsGovernamentais,BINsGovernamentaisDetail,VerificacaoEstrangeiros,VerificacaoEstrangeirosDetail enrichment
              
              class TrackingUsuarios,TrackingUsuariosDetail pipeline
              class FallbackContextosLongos,FallbackContextosLongosDetail analysis
              
              %% Aplica√ß√£o de estilos iniciais
              class EntradaDados,AlertasTrad,AlertasIA,AlertasTradList,AlertasIAList,AlertasCH,AlertasCHDet,AlertasPIX,AlertasPIXDet,AlertasInternacionais,AlertasInternacionaisDet,AlertasOutros,AlertasOutrosDet source
              
              class FiltragemExclusoes,ExclusoesAuto,ExclusoesAutoDet filter
              
              class ProcessamentoDados,FormatacaoDados,FormatacaoDadosDet,GeracaoPrompt,GeracaoPromptDet process
              class SystemPrompt,AnalystIdentity,AnalystIdentityDetails,AnalysisParams,AnalysisParamsDetails identity
              class MandatoryAnalysisCriteria,MandatoryAnalysisCriteriaDetails,DataProcessing,DataProcessingDetails analysis
              class RiskClassification,RiskClassificationDetails criteria
              class RegulatoryFramework,RegulatoryFrameworkDetails regulatory
              
              %% Conex√µes espec√≠ficas entre m√≥dulos de fluxo
              HorariosAtipicosDetail --> ProcessamentoDados
              BINsGovernamentaisDetail --> ProcessamentoDados
              TratamentoEspecificoAlertaDetail --> IntegracaoAPIRisk
        </div>
    </div>
    
    <div class="controls">
        <button onclick="window.print()"><i class="fas fa-print"></i> Exportar PDF</button>
        <button onclick="zoomIn()"><i class="fas fa-search-plus"></i> Ampliar</button>
        <button onclick="zoomOut()"><i class="fas fa-search-minus"></i> Reduzir</button>
        <button onclick="openReportModal()"><i class="fas fa-flag"></i> Reportar ao COAF</button>
        <button class="danger" onclick="openDisaccreditModal()"><i class="fas fa-ban"></i> Descredenciar</button>
    </div>
    
    <!-- Modal para Descredenciamento -->
    <div id="disaccreditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Descredenciamento</h2>
            <p>Voc√™ est√° prestes a iniciar o processo de <strong>descredenciamento</strong> deste cliente. Esta a√ß√£o √© irrevers√≠vel e deve ser tomada apenas em casos de alto risco confirmado.</p>
            <p>O descredenciamento ir√°:</p>
            <ul style="margin-left: 20px; margin-bottom: 20px;">
                <li>Bloquear imediatamente todas as opera√ß√µes do cliente</li>
                <li>Iniciar o processo de encerramento da rela√ß√£o comercial</li>
                <li>Gerar um relat√≥rio detalhado para o time de compliance</li>
                <li>Notificar automaticamente os setores respons√°veis</li>
            </ul>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeModals()">Cancelar</button>
                <button class="confirm" onclick="confirmDisaccredit()">Confirmar Descredenciamento</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Reporte ao COAF -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModals()">&times;</span>
            <h2><i class="fas fa-file-alt"></i> Reporte ao COAF</h2>
            <p>Voc√™ est√° prestes a gerar um <strong>relat√≥rio de atividade suspeita</strong> para envio ao COAF (Conselho de Controle de Atividades Financeiras).</p>
            <p>Este relat√≥rio incluir√°:</p>
            <ul style="margin-left: 20px; margin-bottom: 20px;">
                <li>Todos os detalhes da an√°lise atual</li>
                <li>Hist√≥rico completo de transa√ß√µes do cliente</li>
                <li>Padr√µes identificados de comportamento suspeito</li>
                <li>Fundamenta√ß√£o regulat√≥ria (Carta Circular 4001)</li>
            </ul>
            <div class="modal-buttons">
                <button class="cancel" onclick="closeModals()">Cancelar</button>
                <button class="confirm" onclick="confirmReport()">Gerar Relat√≥rio COAF</button>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            securityLevel: 'loose',
            theme: 'dark',
            fontFamily: 'Roboto Mono, monospace',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 40,
                rankSpacing: 80,
                diagramPadding: 30
            }
        });
        
        let scale = 1;
        const mermaidDiv = document.querySelector('.mermaid');
        
        function zoomIn() {
            scale += 0.1;
            mermaidDiv.style.transform = `scale(${scale})`;
            mermaidDiv.style.transformOrigin = 'center center';
        }
        
        function zoomOut() {
            if (scale > 0.5) {
                scale -= 0.1;
                mermaidDiv.style.transform = `scale(${scale})`;
                mermaidDiv.style.transformOrigin = 'center center';
            }
        }
        
        // Fun√ß√µes para gerenciar os modais
        function openDisaccreditModal() {
            document.getElementById('disaccreditModal').style.display = 'flex';
        }
        
        function openReportModal() {
            document.getElementById('reportModal').style.display = 'flex';
        }
        
        function closeModals() {
            document.getElementById('disaccreditModal').style.display = 'none';
            document.getElementById('reportModal').style.display = 'none';
        }
        
        function confirmDisaccredit() {
            alert('Processo de descredenciamento iniciado. Um relat√≥rio ser√° enviado ao time de compliance.');
            closeModals();
        }
        
        function confirmReport() {
            alert('Relat√≥rio para o COAF gerado com sucesso. A equipe de compliance receber√° uma c√≥pia.');
            closeModals();
        }
        
        // Fechar modais ao clicar fora deles
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                closeModals();
            }
        }
    </script>
</body>
</html> 
